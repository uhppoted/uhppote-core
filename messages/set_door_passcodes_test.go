package messages

import (
	"reflect"
	"testing"

	codec "github.com/uhppoted/uhppote-core/encoding/UTO311-L0x"
)

func TestMarshalSetDoorPasscodesRequest(t *testing.T) {
	expected := []byte{
		0x17, 0x8c, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x03, 0x00, 0x00, 0x00, 0x39, 0x30, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x3f, 0x42, 0x0f, 0x00, 0x31, 0xd4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}

	request := SetDoorPasscodesRequest{
		SerialNumber: 405419896,
		Door:         3,
		Passcode1:    12345,
		Passcode2:    0,
		Passcode3:    999999,
		Passcode4:    54321,
	}

	m, err := codec.Marshal(request)
	if err != nil {
		t.Fatalf("Unexpected error: %v", err)
	}

	if !reflect.DeepEqual(m, expected) {
		t.Errorf("Invalid byte array:\nExpected:\n%s\nReturned:\n%s", codec.Dump(expected, ""), codec.Dump(m, ""))
	}
}

func TestFactoryUnmarshalSetDoorPasscodesRequest(t *testing.T) {
	message := []byte{
		0x17, 0x8c, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x03, 0x00, 0x00, 0x00, 0x39, 0x30, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x3f, 0x42, 0x0f, 0x00, 0x31, 0xd4, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}

	request, err := UnmarshalRequest(message)
	if err != nil {
		t.Fatalf("Unexpected error: %v", err)
	}

	if request == nil {
		t.Fatalf("Unexpected request: %v", request)
	}

	rq, ok := request.(*SetDoorPasscodesRequest)
	if !ok {
		t.Fatalf("Invalid request type - expected:%T, got: %T", &SetDoorPasscodesRequest{}, request)
	}

	if rq.MsgType != 0x8c {
		t.Errorf("Incorrect 'message type' from valid message - expected:%02x, got:%02x", 0x8c, rq.MsgType)
	}

	if rq.SerialNumber != 405419896 {
		t.Errorf("Incorrect 'serial number' from valid message - expected:%v, got:%v", 405419896, rq.SerialNumber)
	}

	if rq.Door != 3 {
		t.Errorf("Incorrect 'door' from valid message - expected:%d, got:%d", 3, rq.Door)
	}

	if rq.Passcode1 != 12345 {
		t.Errorf("Incorrect 'passcode 1' from valid message - expected:%d, got:%d", 12345, rq.Passcode1)
	}

	if rq.Passcode2 != 0 {
		t.Errorf("Incorrect 'passcode 2' from valid message - expected:%d, got:%d", 0, rq.Passcode2)
	}

	if rq.Passcode3 != 999999 {
		t.Errorf("Incorrect 'passcode 3' from valid message - expected:%d, got:%d", 999999, rq.Passcode3)
	}

	if rq.Passcode4 != 54321 {
		t.Errorf("Incorrect 'passcode 4' from valid message - expected:%d, got:%d", 54321, rq.Passcode4)
	}
}

func TestUnmarshalSetDoorPasscodesResponse(t *testing.T) {
	message := []byte{
		0x17, 0x8c, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}

	reply := SetDoorPasscodesResponse{}

	err := codec.Unmarshal(message, &reply)
	if err != nil {
		t.Fatalf("Unexpected error: %v\n", err)
	}

	if reply.MsgType != 0x8c {
		t.Errorf("Incorrect 'message type' - expected:%02x, got:%02x", 0x8c, reply.MsgType)
	}

	if reply.SerialNumber != 405419896 {
		t.Errorf("Incorrect 'serial number' from valid message - expected:%v, got:%v", 405419896, reply.SerialNumber)
	}

	if !reply.Succeeded {
		t.Errorf("Incorrect 'succeeded' - expected:%v, got:%v", true, reply.Succeeded)
	}
}

func TestFactoryUnmarshalDoorPasscodesResponse(t *testing.T) {
	message := []byte{
		0x17, 0x8c, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}

	response, err := UnmarshalResponse(message)
	if err != nil {
		t.Fatalf("Unexpected error: %v", err)
	} else if response == nil {
		t.Fatalf("Unexpected response: %v", response)
	}

	reply, ok := response.(*SetDoorPasscodesResponse)
	if !ok {
		t.Fatalf("Invalid response type - expected:%T, got: %T", &SetDoorPasscodesResponse{}, response)
	}

	if reply.MsgType != 0x8c {
		t.Errorf("Incorrect 'message type' - expected:%02x, got:%02x", 0x8c, reply.MsgType)
	}

	if reply.SerialNumber != 405419896 {
		t.Errorf("Incorrect 'serial number' from valid message - expected:%v, got:%v", 405419896, reply.SerialNumber)
	}

	if !reply.Succeeded {
		t.Errorf("Incorrect 'succeeded' - expected:%v, got:%v\n", true, reply.Succeeded)
	}
}

func TestUnmarshalDoorPasscodesResponseWithInvalidMsgType(t *testing.T) {
	message := []byte{
		0x17, 0x94, 0x00, 0x00, 0x41, 0x78, 0x1e, 0x12, 0x20, 0x19, 0x12, 0x29, 0x12, 0x34, 0x56, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}

	reply := SetDoorPasscodesResponse{}

	err := codec.Unmarshal(message, &reply)
	if err == nil {
		t.Fatalf("Expected error: '%v'", "Invalid value in message - expected 0x8c, received 0x94")
	}
}
